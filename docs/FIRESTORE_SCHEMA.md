# Backend Firestore Schema Reference

> **CRITICAL**: This backend must match the Flutter app schema exactly. Any deviation will cause data inconsistencies and app crashes.
> 
> **Source of Truth**: `/tasker/docs/firebase-firestore-structure.md`

---

## Quick Reference

### Field Naming Rules

1. **Use camelCase**: `createdAt`, `projectId`, `isCompleted`
2. **Booleans prefix with `is`**: `isEncrypted`, `isDeleted`, `isActive`
3. **Timestamps suffix with `At`**: `createdAt`, `updatedAt`, `respondedAt`
4. **Never use redundant ID fields**: Document ID is the ID (no `taskId` field in task document)

### Timestamp Handling

```javascript
// ✅ CORRECT - Use server timestamp for creation
const taskData = {
  // ... other fields
  createdAt: admin.firestore.FieldValue.serverTimestamp(),
  updatedAt: admin.firestore.FieldValue.serverTimestamp()
};

// ✅ CORRECT - Read timestamp
const createdAt = taskDoc.data().createdAt.toDate(); // JavaScript Date

// ❌ WRONG - Never use client time for creation
createdAt: new Date() // Clock skew issues!
```

### Enum Storage

Store enums as **lowercase strings** matching enum value names:

```javascript
// ✅ CORRECT
status: 'pending'        // TaskStatus.pending
status: 'in_progress'    // TaskStatus.in_progress
status: 'completed'      // TaskStatus.completed

// ❌ WRONG
status: 'PENDING'        // Uppercase not allowed
status: 'In Progress'    // Spaces not allowed
```

---

## Collections Reference

### 1. `users/{userId}`

**Document ID**: Firebase Auth UID (same as `id` field)

```javascript
{
  id: userId,                      // String - Firebase Auth UID (same as doc ID)
  email: "user@example.com",       // String - lowercase
  displayName: "John Doe",         // String | null
  photoUrl: "https://...",         // String | null
  createdAt: Timestamp,            // Timestamp - use serverTimestamp()
  updatedAt: Timestamp | null      // Timestamp | null
}
```

**Web Backend Code**:
```javascript
// Create user
const userRef = db.collection('users').doc(firebaseAuthUid);
await userRef.set({
  id: firebaseAuthUid,
  email: email.toLowerCase(),
  displayName: displayName || null,
  photoUrl: photoUrl || null,
  createdAt: admin.firestore.FieldValue.serverTimestamp(),
  updatedAt: null
});
```

---

### 2. `projects/{projectId}`

**Document ID**: Auto-generated by Firestore

```javascript
{
  name: "My Project",              // String - required
  description: "Project desc",     // String | null
  members: ["userId1", "userId2"], // Array<String> - required
  ownerId: "userId1",              // String - required
  memberRoles: {                   // Object - required
    "userId1": "owner",
    "userId2": "editor"
  },
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

**Web Backend Code**:
```javascript
// ✅ CORRECT - Create project
const projectRef = db.collection('projects').doc();
await projectRef.set({
  name: projectName,
  description: description || null,
  members: [ownerId],
  ownerId: ownerId,
  memberRoles: {
    [ownerId]: 'owner'
  },
  createdAt: admin.firestore.FieldValue.serverTimestamp(),
  updatedAt: null
});

// ❌ WRONG - Don't add projectId field
await projectRef.set({
  projectId: projectRef.id,  // ❌ WRONG - redundant field
  // ...
});
```

**Roles**: `"owner"`, `"admin"`, `"editor"`, `"viewer"` (lowercase strings)

---

### 3. `tasks/{taskId}`

**Document ID**: Auto-generated by Firestore

```javascript
{
  projectId: "proj123",            // String - required
  title: "Task title",             // String - required
  description: "Task desc",        // String | null
  isDescriptionEncrypted: false,   // Boolean - default false
  dueDate: Timestamp | null,       // Timestamp | null
  status: "pending",               // String - "pending" | "in_progress" | "completed"
  reminderEnabled: false,          // Boolean - default false
  assignees: ["userId1"],          // Array<String> - default []
  assignedBy: "userId1",           // String | null
  assignedAt: Timestamp | null,    // Timestamp | null
  recurrencePattern: "none",       // String - "none" | "daily" | "weekly" | "monthly"
  recurrenceInterval: 1,           // Number - 1-999999
  recurrenceEndDate: Timestamp | null,  // Timestamp | null
  parentRecurringTaskId: null,     // String | null
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

**Web Backend Code**:
```javascript
// ✅ CORRECT - Create task
const taskRef = db.collection('tasks').doc();
await taskRef.set({
  projectId: projectId,
  title: title,
  description: description || null,
  isDescriptionEncrypted: false,
  dueDate: dueDate ? admin.firestore.Timestamp.fromDate(new Date(dueDate)) : null,
  status: 'pending',
  reminderEnabled: false,
  assignees: assignees || [],
  assignedBy: null,
  assignedAt: null,
  recurrencePattern: 'none',
  recurrenceInterval: 1,
  recurrenceEndDate: null,
  parentRecurringTaskId: null,
  createdAt: admin.firestore.FieldValue.serverTimestamp(),
  updatedAt: null
});

// ❌ WRONG - Don't use these field names
await taskRef.set({
  taskId: taskRef.id,         // ❌ WRONG - use document ID
  createdBy: userId,          // ❌ WRONG - no createdBy field
  priority: 'high',           // ❌ WRONG - no priority field
  tags: ['tag1'],             // ❌ WRONG - no tags field
  // ...
});
```

**Status Values**: `"pending"`, `"in_progress"`, `"completed"` (lowercase with underscore)

---

### 4. `subtasks/{subtaskId}`

**Document ID**: Auto-generated by Firestore

```javascript
{
  taskId: "task123",               // String - required
  title: "Subtask title",          // String - required
  isCompleted: false,              // Boolean - default false
  dueDate: Timestamp | null,       // Timestamp | null
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

**Web Backend Code**:
```javascript
// ✅ CORRECT - Create subtask
const subtaskRef = db.collection('subtasks').doc();
await subtaskRef.set({
  taskId: parentTaskId,
  title: title,
  isCompleted: false,
  dueDate: dueDate ? admin.firestore.Timestamp.fromDate(new Date(dueDate)) : null,
  createdAt: admin.firestore.FieldValue.serverTimestamp(),
  updatedAt: null
});
```

---

### 5. `routines/{routineId}`

**Document ID**: Auto-generated by Firestore

```javascript
{
  userId: "user123",               // String - required
  title: "Morning routine",        // String - required
  description: "Routine desc",     // String | null
  frequency: "daily",              // String - "daily" | "weekly" | "custom"
  daysOfWeek: [1, 3, 5],          // Array<Number> - 1=Mon, 7=Sun
  timeOfDay: "08:00",             // String | null - HH:mm format
  isActive: true,                  // Boolean - default true
  reminderEnabled: false,          // Boolean - default false
  reminderMinutesBefore: 15,       // Number - default 15
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

---

### 6. `invitations/{invitationId}`

**Document ID**: Auto-generated by Firestore

```javascript
{
  projectId: "proj123",                   // String - required
  projectName: "Project Name",            // String - required
  invitedByUserId: "user123",             // String - required
  invitedByUserName: "John Doe",          // String - required
  invitedEmail: "invitee@example.com",    // String - lowercase, required
  invitedUserId: "user456",               // String | null - if user registered
  status: "pending",                      // String - "pending" | "accepted" | "declined" | "cancelled"
  role: "editor",                         // String - "owner" | "admin" | "editor" | "viewer"
  message: "Join my project",             // String | null
  createdAt: Timestamp,                   // Timestamp - required
  respondedAt: Timestamp | null           // Timestamp | null
}
```

**Web Backend Code**:
```javascript
// ✅ CORRECT - Create invitation
const invitationRef = db.collection('invitations').doc();

// Check if user exists by email
const userSnapshot = await db.collection('users')
  .where('email', '==', email.toLowerCase())
  .limit(1)
  .get();

const invitedUserId = !userSnapshot.empty ? userSnapshot.docs[0].id : null;

await invitationRef.set({
  projectId: projectId,
  projectName: projectName,
  invitedByUserId: inviterUserId,
  invitedByUserName: inviterName,
  invitedEmail: email.toLowerCase(),
  invitedUserId: invitedUserId,
  status: 'pending',
  role: role,
  message: message || null,
  createdAt: admin.firestore.FieldValue.serverTimestamp(),
  respondedAt: null
});

// If user exists, add to their pendingInvitations
if (invitedUserId) {
  await db.collection('users')
    .doc(invitedUserId)
    .collection('pendingInvitations')
    .doc(invitationRef.id)
    .set({
      invitationId: invitationRef.id,
      projectId: projectId,
      projectName: projectName,
      invitedBy: inviterName,
      createdAt: admin.firestore.FieldValue.serverTimestamp()
    });
}
```

---

### 7. `mindMaps/{mindMapId}`

```javascript
{
  title: "Mind Map Title",         // String - required
  description: "Description",      // String | null
  userId: "user123",               // String - required
  rootNodeId: "node123",           // String - required
  collaboratorIds: ["user456"],    // Array<String> - default []
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

---

### 8. `mindMapNodes/{nodeId}`

```javascript
{
  mindMapId: "mindMap123",         // String - required
  text: "Node text",               // String - required
  parentId: "node123",             // String | null - null for root
  childIds: ["node456"],           // Array<String> - default []
  x: 100.0,                        // Number - required
  y: 200.0,                        // Number - required
  color: "blue",                   // String - "blue" | "green" | "yellow" | etc.
  isCollapsed: false,              // Boolean - default false
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

---

## Subcollections

### `projects/{projectId}/members/{userId}`

**Document ID**: User ID

```javascript
{
  userId: "user123",               // String - same as doc ID
  email: "user@example.com",       // String - required
  displayName: "John Doe",         // String - required
  photoUrl: "https://...",         // String | null
  role: "editor",                  // String - "owner" | "admin" | "editor" | "viewer"
  addedAt: Timestamp,              // Timestamp - required
  addedBy: "user456"               // String - required
}
```

---

### `projects/{projectId}/messages/{messageId}`

**Document ID**: Auto-generated

```javascript
{
  projectId: "proj123",            // String - denormalized
  senderId: "user123",             // String - required
  senderName: "John Doe",          // String - required
  text: "Message text",            // String - required
  isEncrypted: false,              // Boolean - default false
  createdAt: Timestamp,            // Timestamp - required
  editedAt: Timestamp | null,      // Timestamp | null
  isDeleted: false                 // Boolean - default false (soft delete)
}
```

---

### `users/{userId}/sticky_notes/{noteId}`

**Document ID**: Auto-generated

```javascript
{
  title: "Note title",             // String | null
  content: "Note content",         // String - required (Quill Delta JSON)
  color: "yellow",                 // String - "yellow" | "pink" | "blue" | etc.
  position: {                      // Object - required
    x: 100.0,                      // Number
    y: 200.0                       // Number
  },
  userId: "user123",               // String - denormalized
  zIndex: 0,                       // Number - default 0
  width: 200.0,                    // Number - default 200.0
  height: 200.0,                   // Number - default 200.0
  createdAt: Timestamp,            // Timestamp - required
  updatedAt: Timestamp | null      // Timestamp | null
}
```

---

### `users/{userId}/notifications/{notificationId}`

**Document ID**: Auto-generated

```javascript
{
  userId: "user123",               // String - denormalized
  type: "taskAssigned",            // String - see NotificationType enum
  title: "Task Assigned",          // String - required
  body: "You have a new task",     // String - required
  imageUrl: "https://...",         // String | null
  data: {                          // Object - contextual data
    projectId: "proj123",
    taskId: "task456"
  },
  createdAt: Timestamp,            // Timestamp - required
  isRead: false,                   // Boolean - default false
  actionUrl: "/tasks/task456"      // String | null - deep link
}
```

**NotificationType Values**:
- `"invitationReceived"`, `"invitationAccepted"`, `"invitationDeclined"`
- `"taskAssigned"`, `"taskReassigned"`, `"taskUnassigned"`, `"taskCompleted"`
- `"taskCommentAdded"`, `"taskDueSoon"`, `"taskOverdue"`
- `"memberAdded"`, `"memberRemoved"`, `"memberRoleChanged"`
- `"projectShared"`, `"projectArchived"`
- `"taskReminder"`, `"routineReminder"`

---

### `users/{userId}/pendingInvitations/{invitationId}`

**Document ID**: Invitation ID (matches `invitations/{invitationId}`)

```javascript
{
  invitationId: "inv123",          // String - reference to invitations collection
  projectId: "proj123",            // String - required
  projectName: "Project Name",     // String - required
  invitedBy: "John Doe",           // String - required
  createdAt: Timestamp             // Timestamp - required
}
```

---

## Common Patterns

### Query Examples

```javascript
// Get user's projects
const projects = await db.collection('projects')
  .where('members', 'array-contains', userId)
  .orderBy('createdAt', 'desc')
  .get();

// Get project tasks
const tasks = await db.collection('tasks')
  .where('projectId', '==', projectId)
  .where('status', '==', 'pending')
  .orderBy('createdAt', 'desc')
  .get();

// Get user's pending invitations
const invitations = await db.collection('invitations')
  .where('invitedEmail', '==', email.toLowerCase())
  .where('status', '==', 'pending')
  .orderBy('createdAt', 'desc')
  .get();
```

### Update Patterns

```javascript
// Update with timestamp
await taskRef.update({
  status: 'completed',
  updatedAt: admin.firestore.FieldValue.serverTimestamp()
});

// Add to array atomically
await projectRef.update({
  members: admin.firestore.FieldValue.arrayUnion(newUserId),
  [`memberRoles.${newUserId}`]: 'editor',
  updatedAt: admin.firestore.FieldValue.serverTimestamp()
});

// Remove from array atomically
await projectRef.update({
  members: admin.firestore.FieldValue.arrayRemove(userId),
  [`memberRoles.${userId}`]: admin.firestore.FieldValue.delete(),
  updatedAt: admin.firestore.FieldValue.serverTimestamp()
});
```

---

## Migration Checklist

When updating backend code to match this schema:

- [ ] Remove all redundant ID fields (e.g., `taskId`, `projectId` in document data)
- [ ] Rename `createdBy` to match actual schema (tasks don't have `createdBy`)
- [ ] Remove non-existent fields (`priority`, `tags` in tasks, `color`/`icon` in projects)
- [ ] Update `status` values to use underscores (`in_progress` not `in-progress`)
- [ ] Add missing required fields (`members`, `memberRoles` in projects)
- [ ] Use `serverTimestamp()` for all `createdAt` fields
- [ ] Store emails in lowercase
- [ ] Store enums as lowercase strings
- [ ] Update query field names to match schema

---

## Testing

Before deploying backend changes:

1. **Test with Flutter app**: Ensure data syncs correctly
2. **Check Firestore console**: Verify document structure matches
3. **Test offline sync**: Flutter app should cache and sync properly
4. **Verify queries**: All indexes exist and queries return expected data
5. **Check security rules**: Ensure rules match updated schema

---

## Related Documentation

- **Full Schema**: `/tasker/docs/firebase-firestore-structure.md`
- **Security Rules**: `/tasker/firestore.rules`
- **Flutter Models**: `/tasker/lib/src/features/*/domain/models/`

---

**Last Updated**: January 2025  
**Status**: ⚠️ Backend needs schema updates to match Flutter app
